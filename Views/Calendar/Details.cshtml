@using System.Linq
@using System.Web.Mvc
@using System.Web.Mvc.Html
@using DotNetNuke.Web.Client.ClientResourceManagement
@using DotNetNuke.Framework.JavaScriptLibraries
@using CourseBooking.Models
@inherits DotNetNuke.Web.Mvc.Framework.DnnWebViewPage<CourseScheduleEntity>

@{
    DotNetNuke.Framework.JavaScriptLibraries.JavaScript.RequestRegistration(CommonJs.jQuery);
    DotNetNuke.Framework.JavaScriptLibraries.JavaScript.RequestRegistration(CommonJs.jQueryUI);
    DotNetNuke.Framework.ServicesFramework.Instance.RequestAjaxAntiForgerySupport();

    var localStartTime = Model.StartTime.ToLocalTime();
    var localEndTime = Model.EndTime.ToLocalTime();
    var isRegistered = ViewBag.IsRegistered as bool? ?? false;
    var userBooking = ViewBag.UserBooking as BookingEntity;
    var canRegister = ViewBag.CanRegister as bool? ?? false;
}

<div class="course-booking-detail">
    <h2>Tanfolyam részletek</h2>

    <div class="booking-details-container">
        <div class="booking-section">
            <h3>Tanfolyam információk</h3>

            <div class="form-group">
                <label class="control-label col-md-4">Tanfolyam neve</label>
                <div class="col-md-8">
                    <p class="form-control-static">@Model.CoursePlan.Name</p>
                </div>
            </div>

            <div class="form-group">
                <label class="control-label col-md-4">Kategória</label>
                <div class="col-md-8">
                    <p class="form-control-static">@Model.CoursePlan.CourseCategory</p>
                </div>
            </div>

            <div class="form-group">
                <label class="control-label col-md-4">Dátum</label>
                <div class="col-md-8">
                    <p class="form-control-static">@localStartTime.ToString("yyyy. MMMM d.")</p>
                </div>
            </div>

            <div class="form-group">
                <label class="control-label col-md-4">Időpont</label>
                <div class="col-md-8">
                    <p class="form-control-static">@localStartTime.ToString("HH:mm") - @localEndTime.ToString("HH:mm")</p>
                </div>
            </div>

            <div class="form-group">
                <label class="control-label col-md-4">Időtartam</label>
                <div class="col-md-8">
                    <p class="form-control-static">@Model.CoursePlan.DurationHours óra</p>
                </div>
            </div>

            <div class="form-group">
                <label class="control-label col-md-4">Ár</label>
                <div class="col-md-8">
                    <p class="form-control-static">@Model.CoursePlan.Price.ToString("N0") Ft</p>
                </div>
            </div>

            <div class="form-group">
                <label class="control-label col-md-4">Szabad helyek</label>
                <div class="col-md-8">
                    <p class="form-control-static">@Model.RemainingSeats / @Model.AvailableSeats</p>
                </div>
            </div>

            <div class="form-group">
                <label class="control-label col-md-4">Leírás</label>
                <div class="col-md-8">
                    <p class="form-control-static">@Model.CoursePlan.Description</p>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(Model.CoursePlan.PrerequisiteIds))
            {
                <div class="form-group">
                    <label class="control-label col-md-4">Előfeltételek</label>
                    <div class="col-md-8">
                        <p class="form-control-static">@Model.CoursePlan.PrerequisiteIds</p>
                    </div>
                </div>
            }
        </div>

        @if (isRegistered && userBooking != null)
        {
            <div class="booking-section">
                <h3>Az Ön foglalása</h3>

                <div class="form-group">
                    <label class="control-label col-md-4">Foglalás azonosító</label>
                    <div class="col-md-8">
                        <p class="form-control-static">@userBooking.ID</p>
                    </div>
                </div>

                <div class="form-group">
                    <label class="control-label col-md-4">Foglalás ideje</label>
                    <div class="col-md-8">
                        <p class="form-control-static">@userBooking.BookingTime.ToLocalTime().ToString("yyyy. MM. dd. HH:mm")</p>
                    </div>
                </div>

                <div class="form-group">
                    <label class="control-label col-md-4">Állapot</label>
                    <div class="col-md-8">
                        <p class="form-control-static">
                            @(userBooking.IsCancelled ? "Lemondva" : "Aktív")
                        </p>
                    </div>
                </div>

                @if (!string.IsNullOrEmpty(userBooking.VoucherCode))
                {
                    <div class="form-group">
                        <label class="control-label col-md-4">Kupon kód</label>
                        <div class="col-md-8">
                            <div class="voucher-code">
                                <span id="voucherCode">@userBooking.VoucherCode</span>
                                <button type="button" id="copyVoucher" class="btn btn-sm btn-default">
                                    <i class="fa fa-copy"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                }

                <div class="form-group">
                    <label class="control-label col-md-4">Fizetési állapot</label>
                    <div class="col-md-8">
                        <p class="form-control-static">@userBooking.PaymentStatus</p>
                    </div>
                </div>
            </div>
        }
        else if (Request.IsAuthenticated && canRegister)
        {
            <div class="registration-section">
                <h3>Foglalás</h3>

                <form action="@Url.Action("Register", "Calendar")" method="post" class="form-horizontal" role="form">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" value="@Model.ID" />

                    <div class="form-group">
                        <label class="control-label col-md-4">Megjegyzés (opcionális)</label>
                        <div class="col-md-8">
                            <textarea name="notes" class="form-control" rows="3"></textarea>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="col-md-offset-4 col-md-8">
                            <button type="submit" class="btn btn-primary">Foglalás véglegesítése</button>
                        </div>
                    </div>
                </form>
            </div>
        }
        else if (!Request.IsAuthenticated)
        {
            <div class="registration-message">
                <div class="alert alert-info">
                    <strong>Figyelem!</strong> A foglaláshoz be kell jelentkeznie.
                </div>
            </div>
        }
        else if (Model.RemainingSeats <= 0)
        {
            <div class="registration-message">
                <div class="alert alert-warning">
                    <strong>Sajnáljuk!</strong> Ez a tanfolyam már betelt.
                </div>
            </div>
        }
        else if (isRegistered)
        {
            <div class="registration-message">
                <div class="alert alert-info">
                    <strong>Információ:</strong> Ön már regisztrált erre a tanfolyamra.
                </div>
            </div>
        }
    </div>

    <div class="booking-actions">
        @if (isRegistered && userBooking != null && !userBooking.IsCancelled && Model.StartTime > DateTime.UtcNow.AddHours(24))
        {
            <form action="@Url.Action("Cancel", "Calendar", new { id = userBooking.ID })" method="post" class="cancel-form" onsubmit="return confirm('Biztosan lemondja a foglalást?');">
                @Html.AntiForgeryToken()
                <button type="submit" class="btn btn-danger">Foglalás lemondása</button>
            </form>
        }

        <a href="@Url.Action("Index")" class="btn btn-default">Vissza a naptárhoz</a>
    </div>
</div>

@{
    ClientResourceManager.RegisterStyleSheet(Dnn.DnnPage, "~/DesktopModules/MVC/CourseBooking/module.css");
}

<script type="text/javascript">
    $(document).ready(function () {
        // Copy voucher code
        $("#copyVoucher").click(function () {
            var voucherText = $("#voucherCode").text();

            // Create temporary element
            var tempInput = $("<input>");
            $("body").append(tempInput);
            tempInput.val(voucherText).select();

            // Execute copy command
            document.execCommand("copy");
            tempInput.remove();

            // Show success message
            var $btn = $(this);
            var originalHtml = $btn.html();
            $btn.html('<i class="fa fa-check"></i>');

            setTimeout(function () {
                $btn.html(originalHtml);
            }, 1500);
        });
    });
</script>