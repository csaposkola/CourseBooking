@using System.Linq
@using System.Web.Mvc
@using System.Web.Mvc.Html
@using DotNetNuke.Web.Client.ClientResourceManagement
@using DotNetNuke.Framework.JavaScriptLibraries
@using CourseBooking.Models
@inherits DotNetNuke.Web.Mvc.Framework.DnnWebViewPage<IEnumerable<BookingEntity>>

@{
    DotNetNuke.Framework.JavaScriptLibraries.JavaScript.RequestRegistration(CommonJs.jQuery); // Keep for potential future UI enhancements
    // DotNetNuke.Framework.JavaScriptLibraries.JavaScript.RequestRegistration(CommonJs.jQueryUI); // Likely not needed
    DotNetNuke.Framework.ServicesFramework.Instance.RequestAjaxAntiForgerySupport(); // Keep for cancellation form

    var hasUpcomingBookings = Model.Any(b => !b.IsCancelled && b.CourseSchedule.StartTime > DateTime.UtcNow);
    var hasPastBookings = Model.Any(b => b.IsCancelled || b.CourseSchedule.StartTime <= DateTime.UtcNow);

    // No AJAX check needed here
    // Layout = "~/DesktopModules/MVC/CourseBooking/Views/Shared/_Layout.cshtml"; // Should use default layout
}

<div class="user-bookings">
    <h2>Az Ön foglalásai</h2>

    @* ADDED: Display TempData messages *@
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
    }
     @* Use ViewBag here as controller might set it directly on error or get it from TempData *@
    @if (ViewBag.ErrorMessage != null)
    {
        <div class="alert alert-danger">@ViewBag.ErrorMessage</div>
    }
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success">@TempData["SuccessMessage"]</div>
    }
    @if (ViewBag.SuccessMessage != null)
    {
         <div class="alert alert-success">@ViewBag.SuccessMessage</div>
    }
    @* END ADDED *@


    @if (!Model.Any() && ViewBag.ErrorMessage == null) // Only show "no bookings" if there isn't an error message already
    {
        <div class="alert alert-info">
            <p>Önnek még nincs foglalása. <a href="@Url.Action("Index")">Nézze meg a tanfolyam naptárat</a> új foglalás létrehozásához.</p>
        </div>
    }
    else
    {
        if (hasUpcomingBookings)
        {
            <h3>Közelgő foglalások</h3>
            <div class="bookings-table-container table-responsive"> @* Add table-responsive *@
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Tanfolyam</th>
                            <th>Dátum</th>
                            <th>Időpont</th>
                            <th>Foglalás ideje</th>
                            <th>Kupon kód</th>
                            <th>Státusz</th>
                            <th>Műveletek</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var booking in Model.Where(b => !b.IsCancelled && b.CourseSchedule.StartTime > DateTime.UtcNow)
                            .OrderBy(b => b.CourseSchedule.StartTime))
                        {
                            var localStartTime = booking.CourseSchedule.StartTime.ToLocalTime();
                            var localEndTime = booking.CourseSchedule.EndTime.ToLocalTime();

                            <tr>
                                <td>@booking.CourseSchedule.CoursePlan.Name</td>
                                <td>@localStartTime.ToString("yyyy. MMMM d.")</td>
                                <td>@localStartTime.ToString("HH:mm") - @localEndTime.ToString("HH:mm")</td>
                                <td>@booking.BookingTime.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</td>
                                <td>
                                    @if (!string.IsNullOrEmpty(booking.VoucherCode))
                                    {
                                        <span class="voucher-code">@booking.VoucherCode</span>
                                    }
                                    else
                                    {
                                        <span>-</span>
                                    }
                                </td>
                                <td>
                                    <span class="badge badge-success">Aktív</span>
                                </td>
                                <td>
                                    <div class="btn-group">
                                        @* Link to details page (not modal) *@
                                        <a href="@Url.Action("Details", new { id = booking.CourseScheduleID })" class="btn btn-sm btn-default">
                                            <i class="fa fa-search"></i> Részletek
                                        </a>

                                        @if (!booking.IsCancelled && booking.CourseSchedule.StartTime > DateTime.UtcNow.AddHours(24))
                                        {
                                            @* Standard POST form for cancellation *@
                                            <form action="@Url.Action("Cancel", "Calendar", new { id = booking.ID })" method="post"
                                                  class="d-inline cancel-form"
                                                  onsubmit="return confirm('Biztosan lemondja a foglalást?');">
                                                @* REMOVED: data-ajax, callbacks *@
                                                @Html.AntiForgeryToken()
                                                <button type="submit" class="btn btn-sm btn-danger">
                                                    <i class="fa fa-times"></i> Lemondás
                                                </button>
                                            </form>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }

        if (hasPastBookings)
        {
            <h3>Korábbi foglalások</h3>
            <div class="bookings-table-container table-responsive"> @* Add table-responsive *@
                <table class="table table-striped">
                    <thead>
                         <tr>
                            <th>Tanfolyam</th>
                            <th>Dátum</th>
                            <th>Időpont</th>
                            <th>Foglalás ideje</th>
                            <th>Kupon kód</th>
                            <th>Státusz</th>
                            <th>Műveletek</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var booking in Model.Where(b => b.IsCancelled || b.CourseSchedule.StartTime <= DateTime.UtcNow)
                            .OrderByDescending(b => b.CourseSchedule.StartTime))
                        {
                            var localStartTime = booking.CourseSchedule.StartTime.ToLocalTime();
                            var localEndTime = booking.CourseSchedule.EndTime.ToLocalTime();

                            <tr class="@(booking.IsCancelled ? "cancelled-row" : "")">
                                <td>@booking.CourseSchedule.CoursePlan.Name</td>
                                <td>@localStartTime.ToString("yyyy. MMMM d.")</td>
                                <td>@localStartTime.ToString("HH:mm") - @localEndTime.ToString("HH:mm")</td>
                                <td>@booking.BookingTime.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</td>
                                <td>
                                    @if (!string.IsNullOrEmpty(booking.VoucherCode))
                                    {
                                        <span class="voucher-code">@booking.VoucherCode</span>
                                    }
                                    else
                                    {
                                        <span>-</span>
                                    }
                                </td>
                                <td>
                                    @if (booking.IsCancelled)
                                    {
                                        <span class="badge badge-secondary">Lemondva</span>
                                    }
                                    else if (booking.CourseSchedule.StartTime <= DateTime.UtcNow)
                                    {
                                        <span class="badge badge-info">Lezajlott</span>
                                    }
                                </td>
                                <td>
                                     @* Link to details page (not modal) *@
                                    <a href="@Url.Action("Details", new { id = booking.CourseScheduleID })"
                                       class="btn btn-sm btn-default">
                                        <i class="fa fa-search"></i> Részletek
                                    </a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    }

    <div class="booking-actions">
        <a href="@Url.Action("Index")" class="btn btn-default">
             <i class="fa fa-calendar"></i> Vissza a naptárhoz
        </a>
        @* No modal close button needed *@
    </div>
</div>

@{
    // Register stylesheet if not globally registered
    ClientResourceManager.RegisterStyleSheet(Dnn.DnnPage, "~/DesktopModules/MVC/CourseBooking/module.css");
}

@* Removed the script block related to modal opening and AJAX cancellation *@
<style>
.cancelled-row td {
     text-decoration: line-through;
     color: #6c757d; /* Bootstrap's secondary text color */
}
.d-inline { display: inline-block; } /* Helper class for inline form */
</style>