@using DotNetNuke.Web.Client.ClientResourceManagement
@using DotNetNuke.Framework.JavaScriptLibraries
@using System.Linq
@using CourseBooking.Models
@inherits DotNetNuke.Web.Mvc.Framework.DnnWebViewPage<CourseScheduleEntity>

@{
    DotNetNuke.Framework.JavaScriptLibraries.JavaScript.RequestRegistration(CommonJs.jQuery);
    DotNetNuke.Framework.JavaScriptLibraries.JavaScript.RequestRegistration(CommonJs.jQueryUI);

    var coursePlans = ViewBag.CoursePlans as IEnumerable<CoursePlanEntity> ?? Enumerable.Empty<CoursePlanEntity>();
}

<div class="admin-course-schedule-form">
    <h2>Új tanfolyam időpont létrehozása</h2>

    <form action="@Url.Action("Create", "ScheduleAdmin")" method="post" class="form-horizontal" role="form">
        @Html.AntiForgeryToken()
        @Html.ValidationSummary(true, "", new { @class = "text-danger" })

        <div class="form-group">
            <label class="control-label col-md-3">Tanfolyam terv</label>
            <div class="col-md-9">
                <select id="CoursePlanID" name="CoursePlanID" class="form-control" required>
                    <option value="">Válasszon tanfolyamot</option>
                    @foreach (var plan in coursePlans)
                    {
                        <option value="@plan.ID" data-max-capacity="@plan.MaxCapacity" data-duration="@plan.DurationHours">
                            @plan.Name (@plan.DurationHours óra, @plan.CourseCategory)
                        </option>
                    }
                </select>
                @Html.ValidationMessageFor(m => m.CoursePlanID, "", new { @class = "text-danger" })
            </div>
        </div>

        <div class="form-group">
            <label class="control-label col-md-3">Kezdési időpont</label>
            <div class="col-md-9">
                <div class="row">
                    <div class="col-md-6">
                        <input type="date" id="StartDate" name="StartDate" class="form-control" required
                               value="@Model.StartTime.ToLocalTime().ToString("yyyy-MM-dd")" />
                    </div>
                    <div class="col-md-6">
                        <input type="time" id="StartTime" name="StartTime" class="form-control" required
                               value="@Model.StartTime.ToLocalTime().ToString("HH:mm")" />
                    </div>
                </div>
                <small class="text-muted">A kezdési időpont a helyi időzóna szerint.</small>
                @Html.ValidationMessageFor(m => m.StartTime, "", new { @class = "text-danger" })
            </div>
        </div>

        <div class="form-group">
            <label class="control-label col-md-3">Elérhető helyek</label>
            <div class="col-md-9">
                <input type="number" id="AvailableSeats" name="AvailableSeats" class="form-control" required min="1" max="100"
                       value="@(Model.AvailableSeats > 0 ? Model.AvailableSeats : 10)" />
                <small class="text-muted">Alapértelmezés szerint a tanfolyam maximális kapacitása.</small>
                @Html.ValidationMessageFor(m => m.AvailableSeats, "", new { @class = "text-danger" })
            </div>
        </div>

        <div class="form-group">
            <div class="col-md-offset-3 col-md-9">
                <div class="checkbox">
                    <label>
                        <input type="checkbox" id="IsActive" name="IsActive" checked="@Model.IsActive" /> Aktív
                    </label>
                </div>
            </div>
        </div>

        <div class="form-group">
            <div class="col-md-offset-3 col-md-9">
                <button type="submit" class="btn btn-primary">Létrehozás</button>
                <a href="@Url.Action("Index")" class="btn btn-default">Mégse</a>
            </div>
        </div>
    </form>
</div>

@{
    ClientResourceManager.RegisterStyleSheet(Dnn.DnnPage, "~/DesktopModules/MVC/CourseBooking/module.css");
}

<script type="text/javascript">
    $(document).ready(function() {
        // Set default available seats based on course plan
        $('#CoursePlanID').change(function() {
            var selectedOption = $(this).find('option:selected');
            var maxCapacity = selectedOption.data('max-capacity');
            if (maxCapacity) {
                $('#AvailableSeats').val(maxCapacity);
            }
        });

        // Form submission handling
        $('form').submit(function(e) {
            // Combine date and time inputs into StartTime field
            var startDate = $('#StartDate').val();
            var startTime = $('#StartTime').val();

            if (startDate && startTime) {
                // Create a hidden field for the actual StartTime
                $('<input>').attr({
                    type: 'hidden',
                    name: 'StartTime',
                    value: startDate + 'T' + startTime + ':00'
                }).appendTo('form');
            }
        });
    });
</script>